---
title: "Importing death certificate data for COVID"
output: html_notebook
---

```{r, warning=FALSE, message=FALSE}
packages <- c("tidyverse", "janitor", "lubridate", "kableExtra", "RMySQL", "aws.s3")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())), repos = "http://cran.us.r-project.org")  
}



# turn on libraries
library(tidyverse) 
library(janitor) #this is for the clean_names function
library(lubridate) #this is for working with dates
library(kableExtra) #this is for some kable styling in a couple of the queries on this page
library(RMySQL) #this is used for connecting to the mySQL server
options(scipen=999) #avoid scientific notation
library(aws.s3)

```


# change the name of the weekly zip file on both of the next two lines of code

```{r}
unzip('./data/Jan01-June29, 2021 Death File.zip', exdir='./data')

file.rename('./data/Jan01-June29, 2021 Death File.csv', './data/weeklyfile.csv')
```


```{r}

#before running this for the first time, set "adminuserid=" and "adminpwd=" in environ file using your credentials
#for the mysql server
#needs to be read/write privileges on the mySQL server for this to work

#uncomment out and run the next line to edit your environ file
#usethis::edit_r_environ()

#when finished editing environ, need to close and restart RStudio


#this connects to the server
con <- dbConnect(RMySQL::MySQL(), host = Sys.getenv("host"), dbname="newsroomdata",user= Sys.getenv("adminuserid"), password=Sys.getenv("adminpwd"))
    
dbSendQuery(con, "DROP TABLE old_deaths_covid")

dbSendQuery(con, "CREATE TABLE new_deaths_covid LIKE deaths_covid")

dbSendQuery(con, "RENAME TABLE deaths_covid TO old_deaths_covid")

dbSendQuery(con, "RENAME TABLE new_deaths_covid TO deaths_covid")
    
    

```


#Import csv file


```{r}


# load weekly data file
# set the path on the next line


dbSendQuery(con, "LOAD DATA LOCAL INFILE './data/weeklyfile.csv'
INTO table deaths_covid fields terminated by ',' enclosed by '\"' lines terminated by  '\r\n' ignore 1 lines (@ST_FILE_NBR,@DECD_FRST_NME,@DECD_MIDD_NME,@DECD_LST_NME,@DECD_MAIDN_NME,@DECD_SUFX,@ALIAS_FRST_NME,@ALIAS_MIDD_NME,@ALIAS_LST_NME,
@ALIAS_SUFX,@DECD_SEX,@DECD_AGE_TYPE,@DECD_AGE_YR,@DECD_AGE_MON,@DECD_AGE_DAY,@DECD_AGE_HR,@DECD_AGE_MIN,@DECD_BRTH_DT,@DECD_DTH_DT,
@DECD_BRTH_CNTRY,@DECD_BRTH_CNTRY_FIPS_CD,@DECD_BRTH_ST,@DECD_BRTH_ST_FIPS_CD,@DECD_BRTH_CTY,@DECD_BRTH_CTY_FIPS_CD,@DECD_RES_NURSING,
@DECD_RES_FCLTY,@DECD_RES_STRT,@DECD_RES_MLTIUNIT,@DECD_RES_CTY,@DECD_RES_CTY_OTHER,@DECD_RES_CTY_FIPS_CD,@DECD_RES_ST,@DECD_RES_ST_FIPS_CD,
@DECD_RES_ZIP5,@DECD_RES_ZIP4,@DECD_RES_CNTRY,@DECD_RES_CNTRY_OTHER,@DECD_RES_CNTRY_FIPS_CD,@DECD_RES_CNTY,@DECD_RES_CNTY_FIPS_CD,
@DECD_RES_INTL_FL,@DECD_RES_INTL_CD,@DECD_RES_CTY_TWNSHP_LIMITS,@DECD_ARMF_FL,@DECD_MRTL_STATUS,@DECD_MRTL_STATUS_CD,@SPS_FRST_NME,
@SPS_MIDD_NME,@SPS_LST_NME,@FTHR_FRST_NME,@FTHR_MIDD_NME,@FTHR_LST_NME,@FTHR_SFX_NME,@MTHR_FRST_NME,@MTHR_MIDD_NME,@MTHR_MAIDN_NME,
@MTHR_SFX_NME,@IFRMT_TYPE,@IFRMT_FRST_NME,@IFRMT_MIDD_NME,@IFRMT_LST_NME,@IFRMT_SFX_NME,@IFRMT_ENTITY,@IFRMT_RLSHP,@IFRMT_ADDR_SAME_AS_DECD,
@IFRMT_ADDR_STRT,@IFRMT_ADDR_MLTIUNIT,@IFRMT_ADDR_CTY,@IFRMT_ADDR_CTY_OTHER,@IFRMT_ADDR_CTY_FIPS_CD,@IFRMT_ADDR_ST,@IFRMT_ADDR_ST_FIPS_CD,
@IFRMT_ADDR_CNTRY,@IFRMT_ADDR_CNTRY_FIPS_CD,@IFRMT_ADDR_ZIP5,@IFRMT_ADDR_ZIP4,@IFRMT_ADDR_INTL_FL,
@IFRMT_ADDR_INTL_CD,@DECD_PLCE_DTH_TYP,@DECD_PLCE_DTH_OTHR,@DECD_PLCE_DTH_TYP_CD,@DECD_DTH_FCLTY,@DECD_DTH_FCLTY_ID,
@DECD_DTH_FCLTY_OTHR,@DECD_DTH_STRT,@DECD_DTH_MLTIUNIT,@DECD_DTH_CTY,@DECD_DTH_CTY_OTHER,@DECD_DTH_CTY_FIPS_CD,@DECD_DTH_ST,
@DECD_DTH_ST_FIPS_ALPHA_CD,@DECD_DTH_CNTRY,@DECD_DTH_CNTRY_OTHER,@DECD_DTH_CNTRY_FIPS_CD,@DECD_DTH_ZIP5,@DECD_DTH_ZIP4,@DECD_DTH_INTL_FL,
@DECD_DTH_INTL_CD,@DECD_DTH_CNTY,@DECD_DTH_CNTY_FIPS_CD,@DISP_MTHD_CREM,@DISP_MTHD_BURIAL,@DISP_MTHD_DON,@DISP_MTHD_ENT,@DISP_MTHD_RMVL_FRM_ST,
@DISP_MTHD_OTHR,@DISP_MTHD_OTHR_TEXT,@DISP_MTHD_UNKN,@DISP_CMTRY_PLCE,@DISP_CMTRY_PLCE_OTHR,@DISP_CMTRY_CNTRY,@DISP_CMTRY_ST,
@DISP_CMTRY_CTY,@CREM_NME,@CREM_NME_OTHR,@CREM_CNTRY,@CREM_ST,@CREM_CTY,@AUTHR_LIC_NBR,@AUTHR_FRST_NME,@AUTHR_MIDD_NME,
@AUTHR_LST_NME,@AUTHR_TITLE,@INSTITUTION_TYPE,@FD_FH_ESTAB_NBR,@FD_FH_NME,@FD_FH_LOC_STRT,@FD_FH_LOC_MLTIUNIT,@FD_FH_LOC_CTY,@FD_FH_LOC_ST,
@FD_FH_LOC_ST_FIPS_CD,@FD_FH_LOC_ZIP5,@FD_FH_LOC_ZIP4,@FD_FH_LOC_INTL_FL,@FD_FH_LOC_INTL_CD,@FD_FH_LOC_CNTRY,@FD_LIC_NBR,@FD_FRST_NME,
@FD_MIDD_NME,@FD_LST_NME,@FD_SFX_NME,@DECD_DTH_DT_FOUND,@DECD_DTH_DT_MODIFIER,@DECD_DTH_TM,@DECD_DTH_TIME_INDICATOR,@DECD_DTH_TIME_FOUND,
@DECD_DTH_TM_MODIFIER,@ME_CONTACTED,@CA_DISPOSITION_POSTPONE,@CA_DISPOSITION_POSTPONE_REASON,@CA_INJURY_OR_TRAUMA,@CA_INJURY_OR_TRAUMA_DESCRIBE,
@DT_LAST_SEEN_DAY,@DT_LAST_SEEN_MONTH,@DT_LAST_SEEN_YEAR,@CAUSE_DTH_A,@CAUSE_INTRVL_A,@CAUSE_DTH_B,@CAUSE_INTRVL_B,@CAUSE_DTH_C,
@CAUSE_INTRVL_C,@CAUSE_DTH_D,@CAUSE_INTRVL_D,@CAUSE_DTH_OTHR,@ME_AUTPSY,@ME_AUTPSY_RES_AVLBL,@TOBACCO_CONTRIBUTED,@DECD_PREG_DESC,
@DECD_PREG_CD,@CERTFR_MANNER_DTH,@CERTFR_MANNER_DTH_CD,@INJURY_FL,@INJURY_DT,@INJURY_DT_CANNOT_DETERMINE,@INJURY_TM,@INJURY_TM_CANNOT_DETERMINE,
@INJURY_PLCE_TYP,@INJURY_WORK,@INJURY_LOC_STRT,@INJURY_LOC_MLTIUNIT,@INJURY_LOC_CTY,@INJURY_LOC_CTY_OTHER,@INJURY_LOC_CTY_FIPS_CD,
@INJURY_LOC_ST,@INJURY_LOC_ST_FIPS_CD,@INJURY_LOC_CNTRY,@INJURY_LOC_CNTRY_OTHER,@INJURY_LOC_CNTRY_FIPS_CD,@INJURY_LOC_CNTY,@INJURY_LOC_CNTY_FIPS_CD,
@INJURY_LOC_ZIP5,@INJURY_LOC_ZIP4,@INJURY_LOC_INTL_FL,@INJURY_LOC_INTL_CD,@INJURY_DESC,@INJURY_LOC_TRANSPORT,@INJURY_LOC_TRANSPORT_CD,
@CERTFR_FRST_NME,@CERTFR_MIDD_NME,@CERTFR_LST_NME,@CERTFR_SFX_NME,@CERTFR_ADDR_STRT,@CERTFR_ADDR_MLTIUNIT,@CERTFR_ADDR_CTY,@CERTFR_ADDR_CTY_OTHER,
@CERTFR_ADDR_CTY_FIPS_CD,@CERTFR_ADDR_ST,@CERTFR_ADDR_ST_FIPS_CD,@CERTFR_ADDR_CNTRY,@CERTFR_ADDR_CNTRY_OTHER,@CERTFR_ADDR_CNTRY_FIPS_CD,@CERTFR_ADDR_ZIP5,
@CERTFR_ADDR_ZIP4,@CERTFR_ADDR_INTL_FL,@CERTFR_ADDR_INTL_CD,@CERTFR_TITLE,@CERTFR_LIC_NBR,@CERTFR_NPI_CD,@DT_FILED_MED,@DT_FILED_LEGL,
@CMPLT_FL,@DECD_EDUC,@DECD_EDUC_CD,@DECD_OCPTN,@DECD_IDSTY,@SUBJECT_NOT_HISPANIC,@SUBJECT_MEXICAN,@SUBJECT_PUERTO_RICAN,@SUBJECT_CUBAN,
@SUBJECT_OTHER_SPANISH,@SUBJECT_OTHR_SPAN_TXT,@SUBJECT_REFUSED_HISPANIC,@SUBJECT_UNKNOWN_HISPANIC,@SUBJECT_NOTOBTAINABLE_HISPANIC,@SUBJECT_WHITE,
@SUBJECT_AFRICAN_AMERICAN,@SUBJECT_SOMALI,@SUBJECT_ETHIOPIAN,@SUBJECT_LIBERIAN,@SUBJECT_KENYAN,@SUBJECT_SUDANESE,@SUBJECT_NIGERIAN,@SUBJECT_GHANIAN,
@SUBJECT_OTHER_AFRICAN,@SUBJECT_OTHER_AFRICAN_TXT,@SUBJECT_AMERICAN_INDIAN,@SUBJECT_TRIBE_TXT1,@SUBJECT_TRIBE_TXT2,@SUBJECT_ASIAN_INDIAN,
@SUBJECT_CHINESE,@SUBJECT_FILIPINO,@SUBJECT_JAPANESE,@SUBJECT_KOREAN,@SUBJECT_VIETNAMESE,@SUBJECT_HMONG,@SUBJECT_CAMBODIAN,@SUBJECT_LAOTIAN,
@SUBJECT_OTHER_ASIAN,@SUBJECT_OTHR_ASN_TXT1,@SUBJECT_OTHR_ASN_TXT2,@SUBJECT_HAWAIIAN,@SUBJECT_GUAMANIAN_CHAMORRO,@SUBJECT_SAMOAN,
@SUBJECT_OTHER_PACIFIC_ISLANDER,@SUBJECT_OTHR_PAC_ISLE_TXT1,@SUBJECT_OTHR_PAC_ISLE_TXT2,@SUBJECT_OTHER,@SUBJECT_OTHR_TXT1,@SUBJECT_OTHR_TXT2,
@SUBJECT_REFUSED_RACE,@SUBJECT_UNKNOWN,@SUBJECT_NOTOBTAINABLE_RACE,@SUBJECT_RACE_MVR,@SUBJECT_RACE1E,@SUBJECT_RACE2E,@SUBJECT_RACE3E,@SUBJECT_RACE4E,
@SUBJECT_RACE5E,@SUBJECT_RACE6E,@SUBJECT_RACE7E,@SUBJECT_RACE8E,@SUBJECT_RACE16C,@SUBJECT_RACE17C,@SUBJECT_RACE18C,@SUBJECT_RACE19C,@SUBJECT_RACE20C,
@SUBJECT_RACE21C,@SUBJECT_RACE22C,@SUBJECT_RACE23C,@SUBJECT_ETHNICE,@SUBJECT_ETHNIC5C,@SUBJECT_RACEBRG,@RAC_ICD01,@RAC_CREATED01,@RAC_ICD02,
@RAC_CREATED02,@RAC_ICD03,@RAC_CREATED03,@RAC_ICD04,@RAC_CREATED04,@RAC_ICD05,@RAC_CREATED05,@RAC_ICD06,@RAC_CREATED06,@RAC_ICD07,@RAC_CREATED07,
@RAC_ICD08,@RAC_CREATED08,@RAC_ICD09,@RAC_CREATED09,@RAC_ICD10,@RAC_CREATED10,@RAC_ICD11,@RAC_CREATED11,@RAC_ICD12,@RAC_CREATED12,@RAC_ICD13,
@RAC_CREATED13,@RAC_ICD14,@RAC_CREATED14,@RAC_ICD15,@RAC_CREATED15,@RAC_ICD16,@RAC_CREATED16,@RAC_ICD17,@RAC_CREATED17,@RAC_ICD18,@RAC_CREATED18,
@RAC_ICD19,@RAC_CREATED19,@RAC_ICD20,@RAC_CREATED20,@ACME_UNLY_CAUSE_DTH,@MNL_UNLY_CAUSE_DTH,@RACE,@HISPANICETHNICITY,@INJURY_DATE)
SET
ST_FILE_NBR=@ST_FILE_NBR, DECD_FRST_NME=@DECD_FRST_NME,DECD_MIDD_NME=@DECD_MIDD_NME, DECD_LST_NME=@DECD_LST_NME,DECD_MAIDN_NME=@DECD_MAIDN_NME,  DECD_SUFX=@DECD_SUFX,ALIAS_FRST_NME=@ALIAS_FRST_NME, ALIAS_MIDD_NME=@ALIAS_MIDD_NME,
ALIAS_LST_NME=@ALIAS_LST_NME, ALIAS_SUFX=@ALIAS_SUFX,DECD_SEX=@DECD_SEX, DECD_AGE_TYPE=@DECD_AGE_TYPE,
DECD_AGE_YR=@DECD_AGE_YR, DECD_AGE_MON=@DECD_AGE_MON,DECD_AGE_DAY=@DECD_AGE_DAY, DECD_AGE_HR=@DECD_AGE_HR,DECD_AGE_MIN=@DECD_AGE_MIN, DECD_BRTH_DT=STR_TO_DATE(@DECD_BRTH_DT, '%m/%d/%Y'),
DECD_DTH_DT=STR_TO_DATE(@DECD_DTH_DT, '%m/%d/%Y'), DECD_BRTH_CNTRY=@DECD_BRTH_CNTRY,DECD_BRTH_CNTRY_FIPS_CD=@DECD_BRTH_CNTRY_FIPS_CD, DECD_BRTH_ST=@DECD_BRTH_ST,
DECD_BRTH_ST_FIPS_CD=@DECD_BRTH_ST_FIPS_CD, DECD_BRTH_CTY=@DECD_BRTH_CTY,DECD_BRTH_CTY_FIPS_CD=@DECD_BRTH_CTY_FIPS_CD, DECD_RES_NURSING=@DECD_RES_NURSING,
DECD_RES_FCLTY=@DECD_RES_FCLTY, DECD_RES_STRT=@DECD_RES_STRT,DECD_RES_MLTIUNIT=@DECD_RES_MLTIUNIT, DECD_RES_CTY=@DECD_RES_CTY,DECD_RES_CTY_OTHER=@DECD_RES_CTY_OTHER, DECD_RES_CTY_FIPS_CD=@DECD_RES_CTY_FIPS_CD,
DECD_RES_ST=@DECD_RES_ST, DECD_RES_ST_FIPS_CD=@DECD_RES_ST_FIPS_CD,DECD_RES_ZIP5=@DECD_RES_ZIP5, DECD_RES_ZIP4=@DECD_RES_ZIP4,
DECD_RES_CNTRY=@DECD_RES_CNTRY, DECD_RES_CNTRY_OTHER=@DECD_RES_CNTRY_OTHER,DECD_RES_CNTRY_FIPS_CD=@DECD_RES_CNTRY_FIPS_CD, DECD_RES_CNTY=@DECD_RES_CNTY,
DECD_RES_CNTY_FIPS_CD=@DECD_RES_CNTY_FIPS_CD, DECD_RES_INTL_FL=@DECD_RES_INTL_FL,DECD_RES_INTL_CD=@DECD_RES_INTL_CD, DECD_RES_CTY_TWNSHP_LIMITS=@DECD_RES_CTY_TWNSHP_LIMITS,
DECD_ARMF_FL=@DECD_ARMF_FL, DECD_MRTL_STATUS=@DECD_MRTL_STATUS,DECD_MRTL_STATUS_CD=@DECD_MRTL_STATUS_CD, SPS_FRST_NME=@SPS_FRST_NME,
SPS_MIDD_NME=@SPS_MIDD_NME, SPS_LST_NME=@SPS_LST_NME,FTHR_FRST_NME=@FTHR_FRST_NME, FTHR_MIDD_NME=@FTHR_MIDD_NME,FTHR_LST_NME=@FTHR_LST_NME, FTHR_SFX_NME=@FTHR_SFX_NME,
MTHR_FRST_NME=@MTHR_FRST_NME, MTHR_MIDD_NME=@MTHR_MIDD_NME,MTHR_MAIDN_NME=@MTHR_MAIDN_NME, MTHR_SFX_NME=@MTHR_SFX_NME,IFRMT_TYPE=@IFRMT_TYPE, IFRMT_FRST_NME=@IFRMT_FRST_NME,
IFRMT_MIDD_NME=@IFRMT_MIDD_NME, IFRMT_LST_NME=@IFRMT_LST_NME,IFRMT_SFX_NME=@IFRMT_SFX_NME, IFRMT_ENTITY=@IFRMT_ENTITY,IFRMT_RLSHP=@IFRMT_RLSHP, IFRMT_ADDR_SAME_AS_DECD=@IFRMT_ADDR_SAME_AS_DECD,
IFRMT_ADDR_STRT=@IFRMT_ADDR_STRT, IFRMT_ADDR_MLTIUNIT=@IFRMT_ADDR_MLTIUNIT,IFRMT_ADDR_CTY=@IFRMT_ADDR_CTY, IFRMT_ADDR_CTY_OTHER=@IFRMT_ADDR_CTY_OTHER,
IFRMT_ADDR_CTY_FIPS_CD=@IFRMT_ADDR_CTY_FIPS_CD, IFRMT_ADDR_ST=@IFRMT_ADDR_ST,IFRMT_ADDR_ST_FIPS_CD=@IFRMT_ADDR_ST_FIPS_CD, IFRMT_ADDR_CNTRY=@IFRMT_ADDR_CNTRY,
IFRMT_ADDR_CNTRY_FIPS_CD=@IFRMT_ADDR_CNTRY_FIPS_CD, IFRMT_ADDR_ZIP5=@IFRMT_ADDR_ZIP5,IFRMT_ADDR_ZIP4=@IFRMT_ADDR_ZIP4, IFRMT_ADDR_INTL_FL=@IFRMT_ADDR_INTL_FL,
IFRMT_ADDR_INTL_CD=@IFRMT_ADDR_INTL_CD, DECD_PLCE_DTH_TYP=@DECD_PLCE_DTH_TYP,DECD_PLCE_DTH_OTHR=@DECD_PLCE_DTH_OTHR, DECD_PLCE_DTH_TYP_CD=@DECD_PLCE_DTH_TYP_CD,
DECD_DTH_FCLTY=@DECD_DTH_FCLTY, DECD_DTH_FCLTY_ID=@DECD_DTH_FCLTY_ID,DECD_DTH_FCLTY_OTHR=@DECD_DTH_FCLTY_OTHR, DECD_DTH_STRT=@DECD_DTH_STRT,
DECD_DTH_MLTIUNIT=@DECD_DTH_MLTIUNIT, DECD_DTH_CTY=@DECD_DTH_CTY,DECD_DTH_CTY_OTHER=@DECD_DTH_CTY_OTHER, DECD_DTH_CTY_FIPS_CD=@DECD_DTH_CTY_FIPS_CD,
DECD_DTH_ST=@DECD_DTH_ST, DECD_DTH_ST_FIPS_ALPHA_CD=@DECD_DTH_ST_FIPS_ALPHA_CD,DECD_DTH_CNTRY=@DECD_DTH_CNTRY, DECD_DTH_CNTRY_OTHER=@DECD_DTH_CNTRY_OTHER,
DECD_DTH_CNTRY_FIPS_CD=@DECD_DTH_CNTRY_FIPS_CD, DECD_DTH_ZIP5=@DECD_DTH_ZIP5,DECD_DTH_ZIP4=@DECD_DTH_ZIP4, DECD_DTH_INTL_FL=@DECD_DTH_INTL_FL,
DECD_DTH_INTL_CD=@DECD_DTH_INTL_CD, DECD_DTH_CNTY=@DECD_DTH_CNTY,DECD_DTH_CNTY_FIPS_CD=@DECD_DTH_CNTY_FIPS_CD, DISP_MTHD_CREM=@DISP_MTHD_CREM,
DISP_MTHD_BURIAL=@DISP_MTHD_BURIAL, DISP_MTHD_DON=@DISP_MTHD_DON,DISP_MTHD_ENT=@DISP_MTHD_ENT, DISP_MTHD_RMVL_FRM_ST=@DISP_MTHD_RMVL_FRM_ST,
DISP_MTHD_OTHR=@DISP_MTHD_OTHR, DISP_MTHD_OTHR_TEXT=@DISP_MTHD_OTHR_TEXT,DISP_MTHD_UNKN=@DISP_MTHD_UNKN, DISP_CMTRY_PLCE=@DISP_CMTRY_PLCE,
DISP_CMTRY_PLCE_OTHR=@DISP_CMTRY_PLCE_OTHR, DISP_CMTRY_CNTRY=@DISP_CMTRY_CNTRY,DISP_CMTRY_ST=@DISP_CMTRY_ST, DISP_CMTRY_CTY=@DISP_CMTRY_CTY,
CREM_NME=@CREM_NME, CREM_NME_OTHR=@CREM_NME_OTHR,CREM_CNTRY=@CREM_CNTRY, CREM_ST=@CREM_ST,CREM_CTY=@CREM_CTY, AUTHR_LIC_NBR=@AUTHR_LIC_NBR,
AUTHR_FRST_NME=@AUTHR_FRST_NME, AUTHR_MIDD_NME=@AUTHR_MIDD_NME,AUTHR_LST_NME=@AUTHR_LST_NME, AUTHR_TITLE=@AUTHR_TITLE,INSTITUTION_TYPE=@INSTITUTION_TYPE, FD_FH_ESTAB_NBR=@FD_FH_ESTAB_NBR,
FD_FH_NME=@FD_FH_NME, FD_FH_LOC_STRT=@FD_FH_LOC_STRT,FD_FH_LOC_MLTIUNIT=@FD_FH_LOC_MLTIUNIT, FD_FH_LOC_CTY=@FD_FH_LOC_CTY,
FD_FH_LOC_ST=@FD_FH_LOC_ST, FD_FH_LOC_ST_FIPS_CD=@FD_FH_LOC_ST_FIPS_CD,FD_FH_LOC_ZIP5=@FD_FH_LOC_ZIP5, FD_FH_LOC_ZIP4=@FD_FH_LOC_ZIP4,
FD_FH_LOC_INTL_FL=@FD_FH_LOC_INTL_FL, FD_FH_LOC_INTL_CD=@FD_FH_LOC_INTL_CD,FD_FH_LOC_CNTRY=@FD_FH_LOC_CNTRY, FD_LIC_NBR=@FD_LIC_NBR,
FD_FRST_NME=@FD_FRST_NME, FD_MIDD_NME=@FD_MIDD_NME,FD_LST_NME=@FD_LST_NME, FD_SFX_NME=@FD_SFX_NME,DECD_DTH_DT_FOUND=STR_TO_DATE(@DECD_DTH_DT_FOUND, '%m/%d/%Y'), DECD_DTH_DT_MODIFIER=@DECD_DTH_DT_MODIFIER,
DECD_DTH_TM=@DECD_DTH_TM, DECD_DTH_TIME_INDICATOR=@DECD_DTH_TIME_INDICATOR,DECD_DTH_TIME_FOUND=@DECD_DTH_TIME_FOUND, DECD_DTH_TM_MODIFIER=@DECD_DTH_TM_MODIFIER,
ME_CONTACTED=@ME_CONTACTED, CA_DISPOSITION_POSTPONE=@CA_DISPOSITION_POSTPONE,CA_DISPOSITION_POSTPONE_REASON=@CA_DISPOSITION_POSTPONE_REASON, CA_INJURY_OR_TRAUMA=@CA_INJURY_OR_TRAUMA,
CA_INJURY_OR_TRAUMA_DESCRIBE=@CA_INJURY_OR_TRAUMA_DESCRIBE, DT_LAST_SEEN_DAY=@DT_LAST_SEEN_DAY,DT_LAST_SEEN_MONTH=@DT_LAST_SEEN_MONTH, DT_LAST_SEEN_YEAR=@DT_LAST_SEEN_YEAR,
CAUSE_DTH_A=@CAUSE_DTH_A,CAUSE_INTRVL_A=@CAUSE_INTRVL_A,CAUSE_DTH_B=@CAUSE_DTH_B,CAUSE_INTRVL_B=@CAUSE_INTRVL_B,CAUSE_DTH_C=@CAUSE_DTH_C,
CAUSE_INTRVL_C=@CAUSE_INTRVL_C,CAUSE_DTH_D=@CAUSE_DTH_D,CAUSE_INTRVL_D=@CAUSE_INTRVL_D,CAUSE_DTH_OTHR=@CAUSE_DTH_OTHR,ME_AUTPSY=@ME_AUTPSY,
ME_AUTPSY_RES_AVLBL=@ME_AUTPSY_RES_AVLBL,TOBACCO_CONTRIBUTED=@TOBACCO_CONTRIBUTED,DECD_PREG_DESC=@DECD_PREG_DESC,DECD_PREG_CD=@DECD_PREG_CD,
CERTFR_MANNER_DTH=@CERTFR_MANNER_DTH,CERTFR_MANNER_DTH_CD=@CERTFR_MANNER_DTH_CD,INJURY_FL=@INJURY_FL,INJURY_DT_TXT=@INJURY_DT,
INJURY_DT_CANNOT_DETERMINE=@INJURY_DT_CANNOT_DETERMINE,INJURY_TM=@INJURY_TM,INJURY_TM_CANNOT_DETERMINE=@INJURY_TM_CANNOT_DETERMINE,INJURY_PLCE_TYP=@INJURY_PLCE_TYP,
INJURY_WORK=@INJURY_WORK,INJURY_LOC_STRT=@INJURY_LOC_STRT,INJURY_LOC_MLTIUNIT=@INJURY_LOC_MLTIUNIT,INJURY_LOC_CTY=@INJURY_LOC_CTY,
INJURY_LOC_CTY_OTHER=@INJURY_LOC_CTY_OTHER,INJURY_LOC_CTY_FIPS_CD=@INJURY_LOC_CTY_FIPS_CD,INJURY_LOC_ST=@INJURY_LOC_ST,
INJURY_LOC_ST_FIPS_CD=@INJURY_LOC_ST_FIPS_CD,INJURY_LOC_CNTRY=@INJURY_LOC_CNTRY,INJURY_LOC_CNTRY_OTHER=@INJURY_LOC_CNTRY_OTHER,INJURY_LOC_CNTRY_FIPS_CD=@INJURY_LOC_CNTRY_FIPS_CD,
INJURY_LOC_CNTY=@INJURY_LOC_CNTY,INJURY_LOC_CNTY_FIPS_CD=@INJURY_LOC_CNTY_FIPS_CD,INJURY_LOC_ZIP5=@INJURY_LOC_ZIP5,
INJURY_LOC_ZIP4=@INJURY_LOC_ZIP4,INJURY_LOC_INTL_FL=@INJURY_LOC_INTL_FL,INJURY_LOC_INTL_CD=@INJURY_LOC_INTL_CD,
INJURY_DESC=@INJURY_DESC,INJURY_LOC_TRANSPORT=@INJURY_LOC_TRANSPORT,INJURY_LOC_TRANSPORT_CD=@INJURY_LOC_TRANSPORT_CD,CERTFR_FRST_NME=@CERTFR_FRST_NME,
CERTFR_MIDD_NME=@CERTFR_MIDD_NME,CERTFR_LST_NME=@CERTFR_LST_NME,CERTFR_SFX_NME=@CERTFR_SFX_NME,CERTFR_ADDR_STRT=@CERTFR_ADDR_STRT,
CERTFR_ADDR_MLTIUNIT=@CERTFR_ADDR_MLTIUNIT,CERTFR_ADDR_CTY=@CERTFR_ADDR_CTY,CERTFR_ADDR_CTY_OTHER=@CERTFR_ADDR_CTY_OTHER,CERTFR_ADDR_CTY_FIPS_CD=@CERTFR_ADDR_CTY_FIPS_CD,
CERTFR_ADDR_ST=@CERTFR_ADDR_ST,CERTFR_ADDR_ST_FIPS_CD=@CERTFR_ADDR_ST_FIPS_CD,CERTFR_ADDR_CNTRY=@CERTFR_ADDR_CNTRY,CERTFR_ADDR_CNTRY_OTHER=@CERTFR_ADDR_CNTRY_OTHER,
CERTFR_ADDR_CNTRY_FIPS_CD=@CERTFR_ADDR_CNTRY_FIPS_CD,CERTFR_ADDR_ZIP5=@CERTFR_ADDR_ZIP5,CERTFR_ADDR_ZIP4=@CERTFR_ADDR_ZIP4,CERTFR_ADDR_INTL_FL=@CERTFR_ADDR_INTL_FL,
CERTFR_ADDR_INTL_CD=@CERTFR_ADDR_INTL_CD,CERTFR_TITLE=@CERTFR_TITLE,CERTFR_LIC_NBR=@CERTFR_LIC_NBR,CERTFR_NPI_CD=@CERTFR_NPI_CD,
DT_FILED_MED=STR_TO_DATE(@DT_FILED_MED, '%m/%d/%Y'),DT_FILED_LEGL=STR_TO_DATE(@DT_FILED_LEGL, '%m/%d/%Y'),CMPLT_FL=@CMPLT_FL,
DECD_EDUC=@DECD_EDUC,DECD_EDUC_CD=@DECD_EDUC_CD,DECD_OCPTN=@DECD_OCPTN,DECD_IDSTY=@DECD_IDSTY,SUBJECT_NOT_HISPANIC=@SUBJECT_NOT_HISPANIC,
SUBJECT_MEXICAN=@SUBJECT_MEXICAN,SUBJECT_PUERTO_RICAN=@SUBJECT_PUERTO_RICAN,SUBJECT_CUBAN=@SUBJECT_CUBAN,SUBJECT_OTHER_SPANISH=@SUBJECT_OTHER_SPANISH,
SUBJECT_OTHR_SPAN_TXT=@SUBJECT_OTHR_SPAN_TXT,SUBJECT_REFUSED_HISPANIC=@SUBJECT_REFUSED_HISPANIC,SUBJECT_UNKNOWN_HISPANIC=@SUBJECT_UNKNOWN_HISPANIC,
SUBJECT_NOTOBTAINABLE_HISPANIC=@SUBJECT_NOTOBTAINABLE_HISPANIC,SUBJECT_WHITE=@SUBJECT_WHITE,SUBJECT_AFRICAN_AMERICAN=@SUBJECT_AFRICAN_AMERICAN,
SUBJECT_SOMALI=@SUBJECT_SOMALI,SUBJECT_ETHIOPIAN=@SUBJECT_ETHIOPIAN,SUBJECT_LIBERIAN=@SUBJECT_LIBERIAN,SUBJECT_KENYAN=@SUBJECT_KENYAN,
SUBJECT_SUDANESE=@SUBJECT_SUDANESE,SUBJECT_NIGERIAN=@SUBJECT_NIGERIAN,SUBJECT_GHANIAN=@SUBJECT_GHANIAN,SUBJECT_OTHER_AFRICAN=@SUBJECT_OTHER_AFRICAN,
SUBJECT_OTHER_AFRICAN_TXT=@SUBJECT_OTHER_AFRICAN_TXT,SUBJECT_AMERICAN_INDIAN=@SUBJECT_AMERICAN_INDIAN,SUBJECT_TRIBE_TXT1=@SUBJECT_TRIBE_TXT1,
SUBJECT_TRIBE_TXT2=@SUBJECT_TRIBE_TXT2,SUBJECT_ASIAN_INDIAN=@SUBJECT_ASIAN_INDIAN,SUBJECT_CHINESE=@SUBJECT_CHINESE,SUBJECT_FILIPINO=@SUBJECT_FILIPINO,
SUBJECT_JAPANESE=@SUBJECT_JAPANESE,SUBJECT_KOREAN=@SUBJECT_KOREAN,SUBJECT_VIETNAMESE=@SUBJECT_VIETNAMESE,SUBJECT_HMONG=@SUBJECT_HMONG,
SUBJECT_CAMBODIAN=@SUBJECT_CAMBODIAN,SUBJECT_LAOTIAN=@SUBJECT_LAOTIAN,SUBJECT_OTHER_ASIAN=@SUBJECT_OTHER_ASIAN,SUBJECT_OTHR_ASN_TXT1=@SUBJECT_OTHR_ASN_TXT1,
SUBJECT_OTHR_ASN_TXT2=@SUBJECT_OTHR_ASN_TXT2,SUBJECT_HAWAIIAN=@SUBJECT_HAWAIIAN,SUBJECT_GUAMANIAN_CHAMORRO=@SUBJECT_GUAMANIAN_CHAMORRO,
SUBJECT_SAMOAN=@SUBJECT_SAMOAN,SUBJECT_OTHER_PACIFIC_ISLANDER=@SUBJECT_OTHER_PACIFIC_ISLANDER,SUBJECT_OTHR_PAC_ISLE_TXT1=@SUBJECT_OTHR_PAC_ISLE_TXT1,
SUBJECT_OTHR_PAC_ISLE_TXT2=@SUBJECT_OTHR_PAC_ISLE_TXT2,SUBJECT_OTHER=@SUBJECT_OTHER,SUBJECT_OTHR_TXT1=@SUBJECT_OTHR_TXT1,SUBJECT_OTHR_TXT2=@SUBJECT_OTHR_TXT2,
SUBJECT_REFUSED_RACE=@SUBJECT_REFUSED_RACE,SUBJECT_UNKNOWN=@SUBJECT_UNKNOWN,SUBJECT_NOTOBTAINABLE_RACE=@SUBJECT_NOTOBTAINABLE_RACE,
SUBJECT_RACE_MVR=@SUBJECT_RACE_MVR,SUBJECT_RACE1E=@SUBJECT_RACE1E,SUBJECT_RACE2E=@SUBJECT_RACE2E,SUBJECT_RACE3E=@SUBJECT_RACE3E,
SUBJECT_RACE4E=@SUBJECT_RACE4E,SUBJECT_RACE5E=@SUBJECT_RACE5E,SUBJECT_RACE6E=@SUBJECT_RACE6E,SUBJECT_RACE7E=@SUBJECT_RACE7E,SUBJECT_RACE8E=@SUBJECT_RACE8E,
SUBJECT_RACE16C=@SUBJECT_RACE16C,SUBJECT_RACE17C=@SUBJECT_RACE17C,SUBJECT_RACE18C=@SUBJECT_RACE18C,SUBJECT_RACE19C=@SUBJECT_RACE19C,
SUBJECT_RACE20C=@SUBJECT_RACE20C,SUBJECT_RACE21C=@SUBJECT_RACE21C,SUBJECT_RACE22C=@SUBJECT_RACE22C,SUBJECT_RACE23C=@SUBJECT_RACE23C,
SUBJECT_ETHNICE=@SUBJECT_ETHNICE,SUBJECT_ETHNIC5C=@SUBJECT_ETHNIC5C,SUBJECT_RACEBRG=@SUBJECT_RACEBRG,RAC_ICD01=@RAC_ICD01,
RAC_CREATED01=@RAC_CREATED01,RAC_ICD02=@RAC_ICD02,RAC_CREATED02=@RAC_CREATED02,RAC_ICD03=@RAC_ICD03,RAC_CREATED03=@RAC_CREATED03,
RAC_ICD04=@RAC_ICD04,RAC_CREATED04=@RAC_CREATED04,RAC_ICD05=@RAC_ICD05,RAC_CREATED05=@RAC_CREATED05,RAC_ICD06=@RAC_ICD06,RAC_CREATED06=@RAC_CREATED06,
RAC_ICD07=@RAC_ICD07,RAC_CREATED07=@RAC_CREATED07,RAC_ICD08=@RAC_ICD08,RAC_CREATED08=@RAC_CREATED08,RAC_ICD09=@RAC_ICD09,RAC_CREATED09=@RAC_CREATED09,
RAC_ICD10=@RAC_ICD10,RAC_CREATED10=@RAC_CREATED10,RAC_ICD11=@RAC_ICD11,RAC_CREATED11=@RAC_CREATED11,RAC_ICD12=@RAC_ICD12,RAC_CREATED12=@RAC_CREATED12,
RAC_ICD13=@RAC_ICD13,RAC_CREATED13=@RAC_CREATED13,RAC_ICD14=@RAC_ICD14,RAC_CREATED14=@RAC_CREATED14,RAC_ICD15=@RAC_ICD15,RAC_CREATED15=@RAC_CREATED15,
RAC_ICD16=@RAC_ICD16,RAC_CREATED16=@RAC_CREATED16,RAC_ICD17=@RAC_ICD17,RAC_CREATED17=@RAC_CREATED17,RAC_ICD18=@RAC_ICD18,RAC_CREATED18=@RAC_CREATED18,
RAC_ICD19=@RAC_ICD19,RAC_CREATED19=@RAC_CREATED19,RAC_ICD20=@RAC_ICD20,RAC_CREATED20=@RAC_CREATED20,ACME_UNLY_CAUSE_DTH=@ACME_UNLY_CAUSE_DTH,
MNL_UNLY_CAUSE_DTH=@MNL_UNLY_CAUSE_DTH,
STRIBIMPORTDATE=NOW(),
SOURCECODE='MDH- partial year';")


```

# Create a standardized race field
```{r}


#most of the records are coded with numbers and there is a lookup table on the server
dbSendQuery(con, "update deaths_covid 
inner join deaths_race_lkup on deaths_covid.SUBJECT_RACEBRG=deaths_race_lkup.racebridge
set deaths_covid.race = deaths_race_lkup.BigGroup;")


#the remainder need to rely on a series of fields that identify very specific race/cultural groups

dbSendQuery(con, "update deaths_covid set race='White' where race is null and SUBJECT_WHITE='Y';")


dbSendQuery(con, "update deaths_covid set race='Black' where race is null and (SUBJECT_AFRICAN_AMERICAN='Y' or SUBJECT_SOMALI='Y'
or SUBJECT_ETHIOPIAN='Y' or SUBJECT_LIBERIAN='Y' or SUBJECT_KENYAN='Y' or SUBJECT_SUDANESE='Y' or SUBJECT_NIGERIAN='Y'
or SUBJECT_GHANIAN='Y' or SUBJECT_OTHER_AFRICAN='Y');")


dbSendQuery(con, "update deaths_covid set race='American Indian' where race is null and SUBJECT_AMERICAN_INDIAN='Y';")


dbSendQuery(con, "update deaths_covid set race='Asian' where race is null and (SUBJECT_ASIAN_INDIAN='Y' or SUBJECT_CHINESE='Y' or SUBJECT_FILIPINO='Y' or SUBJECT_JAPANESE='Y' 
                                                             or SUBJECT_KOREAN='Y' or SUBJECT_VIETNAMESE='Y' or SUBJECT_HMONG='Y' or SUBJECT_CAMBODIAN='Y' 
                                                             or SUBJECT_LAOTIAN='Y' or SUBJECT_OTHER_ASIAN='Y');")

dbSendQuery(con, "update deaths_covid set race='Pacific Islander' where race is null and (SUBJECT_HAWAIIAN='Y' or SUBJECT_GUAMANIAN_CHAMORRO='Y' or
SUBJECT_SAMOAN='Y' or SUBJECT_OTHER_PACIFIC_ISLANDER='Y');")


dbSendQuery(con, "update deaths_covid set race='Other' where race is null and SUBJECT_OTHER='Y';")

dbSendQuery(con, "update deaths_covid set race='Unknown' where race is null and (SUBJECT_REFUSED_RACE='Y' or SUBJECT_UNKNOWN='Y' or SUBJECT_NOTOBTAINABLE_RACE='Y');")


dbSendQuery(con, "update deaths_covid set HispanicEthnicity='NOT HISPANIC' where subject_not_hispanic='Y';")

dbSendQuery(con, "update deaths_covid set HispanicEthnicity='HISPANIC' where subject_mexican='Y' OR SUBJECT_PUERTO_RICAN='Y' OR SUBJECT_CUBAN='Y'
OR SUBJECT_OTHER_SPANISH='Y';")

dbSendQuery(con, "UPDATE deaths_covid SET HISPANICETHNICITY='UNKNOWN' WHERE SUBJECT_REFUSED_HISPANIC='Y' OR SUBJECT_UNKNOWN_HISPANIC='Y' OR SUBJECT_NOTOBTAINABLE_HISPANIC='Y';")

dbSendQuery(con, "UPDATE deaths_covid SET HISPANICETHNICITY='UNKNOWN' where hispanicethnicity is null;")



Sys.Date()
```

# Populate covidflag field for records we got previously
```{r}

dbSendQuery(con, "update deaths_covid
inner join covidflag_lkup on deaths_covid.st_file_nbr = covidflag_lkup.st_file_nbr
set deaths_covid.covidflag= covidflag_lkup.covidflag" )

Sys.Date()

```




# Find and flag the COVID cases
```{r, message=FALSE}

#these queries are going to look through all the data just imported, even ones that might have
#been flagged in previous weeks; occasionally records are updated and a covid case gets reclassified as negative
#or covid might be removed from cause of death


# this will flag cases where the ICD code has been entered
# that doesn't always happen right away, though, so this doesn't catch all of them

dbSendQuery(con, "update deaths_covid set covidflag='covid' where (RAC_ICD01='U071' or RAC_ICD02='U071' or RAC_ICD03='U071' or RAC_ICD04='U071' OR RAC_ICD05='U071' OR RAC_ICD06='U071'
 OR RAC_ICD07='U071'  OR RAC_ICD08='U071'  OR RAC_ICD09='U071'  OR RAC_ICD10='U071'  OR RAC_ICD11='U071');")


#this looks for keywords in the various cause of death fields

dbSendQuery(con, "update deaths_covid set covidflag='covid'
where covidflag is null 
and (cause_dth_a like '%COVID%' OR
cause_dth_B like '%COVID%' OR
cause_dth_C like '%COVID%' OR
cause_dth_D like '%COVID%' OR 
cause_dth_othr like '%COVID%' OR
cause_dth_a like '%coronavirus%' OR
cause_dth_B like '%coronavirus%' OR
cause_dth_C like '%coronavirus%' OR
cause_dth_D like '%coronavirus%' OR 
cause_dth_othr like '%coronavirus%' or
cause_dth_a like '%SARS-COV-2%' OR
cause_dth_B like '%SARS-COV-2%' OR
cause_dth_C like '%SARS-COV-2%' OR
cause_dth_D like '%SARS-COV-2%' OR 
cause_dth_othr like '%SARS-COV-2%' or
cause_dth_a like '%SARS-COV2%' OR
cause_dth_B like '%SARS-COV2%' OR
cause_dth_C like '%SARS-COV2%' OR
cause_dth_D like '%SARS-COV2%' OR 
cause_dth_othr like '%SARS-COV2%' OR
cause_dth_a like '%SARS COV2%' OR
cause_dth_B like '%SARS COV2%' OR
cause_dth_C like '%SARS COV2%' OR
cause_dth_D like '%SARS COV2%' OR 
cause_dth_othr like '%SARS COV2%' OR
cause_dth_a like '%CORONA VIRUS%' OR
cause_dth_B like '%CORONA VIRUS%' OR
cause_dth_C like '%CORONA VIRUS%' OR
cause_dth_D like '%CORONA VIRUS%' OR 
cause_dth_othr like '%CORONA VIRUS%' or
cause_dth_a like '%SARS-COV%' OR
cause_dth_B like '%SARS-COV%' OR
cause_dth_C like '%SARS-COV%' OR
cause_dth_D like '%SARS-COV%' OR 
cause_dth_othr like '%SARS-COV%' 


); ")

Sys.Date()
```


# flag false cases 
```{r}
dbSendQuery(con, "update deaths_covid set covidflag='FALSE'
where cause_dth_a like '%NOT COVID%' OR
cause_dth_B like '%NOT COVID%' OR
cause_dth_C like '%NOT COVID%' OR
cause_dth_D like '%NOT COVID%' OR 
INJURY_DESC LIKE '%NOT COVID%' OR
cause_dth_othr like '%NOT COVID%' OR
CAUSE_DTH_A like '%COVID 19 NEGATIVE%' or
cause_dth_a like '%COVID TEST NEGATIVE%'
or cause_dth_a like '%COVID 19 NEGATIVE%' OR 
CAUSE_DTH_A LIKE '%COVID NEGATIVE%' or 
cause_dth_othr LIKE '%COVID-19 TEST NEGATIVE%'")


#eliminate deaths where manner of death is listed as accident or suicide but covid was involved
dbSendQuery(con, "update deaths_covid set covidflag='FALSE' where covidflag='covid' and (certfr_manner_dth='SUICIDE' or certfr_manner_dth='ACCIDENT') ")


#this is a death from January 2020 that says "coronavirus" but we confirmed that it's not covid-19
dbSendQuery(con, "UPDATE deaths_covid set covidflag='FALSE' WHERE  st_file_nbr='2020-MN-002678';")

Sys.Date()

```


# check the covid records
use the next query to fix any that got flagged wrong
```{r}

# edit the date in this query to get the most recent records

data1 <- dbSendQuery(con, "select ST_FILE_NBR, CAUSE_DTH_A, CAUSE_DTH_B, CAUSE_DTH_C, CAUSE_DTH_D, CAUSE_DTH_OTHR, DT_FILED_MED
from deaths_covid
where year(decd_dth_dt)=2021 and decd_dth_dt>'2021-06-10' and covidflag='covid' and RAC_ICD01<>'U071' and rac_icd02<>'U071' and RAC_ICD03<>'U071' and RAC_ICD04<>'U071'
order by dt_filed_med")

checkdata <-  fetch(data1, n=-1)

checkdata %>% 
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = TRUE, position="center", font_size=12)

```


# use this to fix any records that have COVID but shouldn't be flagged
most recently this is cases that say they received the covid vaccine

```{r}
dbSendQuery(con, "update deaths_covid set covidflag='FALSE' where st_file_nbr='2021-MN-020636'")


```


# update the covidflag_lkup table
```{r}

#this drops the last backup copy and makes a backup copy of the existing one
dbSendQuery(con, "DROP TABLE covidflag_lkup_old")
dbSendQuery(con, "RENAME TABLE covidflag_lkup TO covidflag_lkup_old")

#this creates the new one for use the next time the script is run
dbSendQuery(con, "create table 
covidflag_lkup
SELECT ST_FILE_NBR, covidflag
from deaths_covid")
```





# Create file for reporters
```{r}

pulldata <-  dbSendQuery(con, "
SELECT TRIM(ST_FILE_NBR) AS STATEID, TRIM(DECD_FRST_NME) AS FIRSTNAME, TRIM(DECD_MIDD_NME) AS MIDDLENAME, TRIM(DECD_LST_NME) AS LASTNAME, 
TRIM(DECD_MAIDN_NME) AS MAIDENNAME, TRIM(DECD_SUFX) AS SUFFIX, DECD_BRTH_DT AS BIRTHDATE, DECD_DTH_DT AS DEATHDATE, TRIM(DECD_SEX) AS GENDER, 
TRIM(RACE) AS RACE, TRIM(HISPANICETHNICITY) AS HISPANICETHNICITY, TRIM(DECD_AGE_TYPE) AS AGE_TYPE, DECD_AGE_YR AS AGEYEARS, 
DECD_AGE_MON AS AGEMONTHS, DECD_AGE_DAY AS AGEDAYS, DECD_AGE_HR AS AGEHOURS, DECD_AGE_MIN AS AGEMINUTES, TRIM(DECD_BRTH_CNTRY) AS BIRTHCOUNTRY, 
TRIM(DECD_BRTH_ST) AS BIRTHSTATE, TRIM(DECD_BRTH_CTY) AS BIRTHCITY, TRIM(DECD_RES_NURSING) AS NURSHOME, TRIM(DECD_RES_FCLTY) AS RESFACILITY , 
TRIM(DECD_RES_STRT) AS RESADDRESS, TRIM(DECD_RES_CNTRY) AS RESCOUNTRY, TRIM(DECD_RES_ST) AS RESSTATE, TRIM(DECD_RES_CNTY) AS RESCOUNTY, 
TRIM(DECD_RES_CTY) AS RESCITY, TRIM(DECD_RES_ZIP5) AS ZIP, TRIM(DECD_ARMF_FL) AS ARMEDFORCES, TRIM(DECD_EDUC) AS YEARSEDUCATION, 
TRIM(DECD_OCPTN) AS OCCUPATION, TRIM(DECD_IDSTY) AS INDUSTRY, TRIM(DECD_MRTL_STATUS) AS MARITALSTATUS,
TRIM(SPS_FRST_NME) AS SPOUSEFIRST, TRIM(SPS_MIDD_NME) AS SPOUSEMIDDLE, TRIM(SPS_LST_NME) AS SPOUSELAST, TRIM(FTHR_FRST_NME) AS FATHERFIRST, 
TRIM(FTHR_MIDD_NME) AS FATHERMIDDLE, TRIM(FTHR_LST_NME) AS FATHERLAST, TRIM(FTHR_SFX_NME) AS FATHERSUFFIX, 
TRIM(MTHR_FRST_NME) AS MOTHERFIRST, TRIM(MTHR_MIDD_NME) AS MOTHERMIDDLE, TRIM(MTHR_MAIDN_NME) AS MOTHERMAIDEN, 
TRIM(DECD_PLCE_DTH_TYP) AS PLACETYPE, TRIM(DECD_PLCE_DTH_OTHR) AS PLACEOTHER, TRIM(DECD_DTH_FCLTY) AS FACILITY, TRIM(DECD_DTH_FCLTY_OTHR) AS FACILITYOTHER, 
TRIM(DECD_DTH_STRT) AS DEATHADDRESS, TRIM(DECD_DTH_CNTRY) AS DEATHCOUNTRY, TRIM(DECD_DTH_ST) AS DEATHSTATE, TRIM(DECD_DTH_CTY) AS DEATHCITY, 
TRIM(DECD_DTH_ZIP5) AS DEATHZIP, TRIM(DECD_DTH_CNTY) AS DEATHCOUNTY, TRIM(CAUSE_DTH_A) AS CAUSEA, cause_intrvl_a,
TRIM(CAUSE_DTH_B) AS CAUSEB,cause_intrvl_b, TRIM(CAUSE_DTH_C) AS CAUSEC,cause_intrvl_c, TRIM(CAUSE_DTH_D) AS CAUSED,
cause_intrvl_d, TRIM(CAUSE_DTH_OTHR) AS CAUSEOTHER, me_autpsy,TRIM(CERTFR_MANNER_DTH) AS MANNERDEATH, 
INJURY_DATE, TRIM(INJURY_PLCE_TYP) AS INJURYPLACE, TRIM(INJURY_WORK) AS INJURYWORK, TRIM(INJURY_LOC_STRT) AS INJURYADDRESS, 
TRIM(INJURY_LOC_ST) AS INJURYSTATE, TRIM(INJURY_LOC_CNTY) AS INJURYCOUNTY, TRIM(INJURY_LOC_CNTRY) AS INJURYCOUNTRY , 
TRIM(INJURY_LOC_CTY) AS INJURYCITY, TRIM(INJURY_LOC_ZIP5) AS INJURYZIP, TRIM(INJURY_DESC) AS INJURYDESC, 
ifrmt_frst_nme as informant_first,ifrmt_midd_nme as informant_middle,ifrmt_lst_nme as informant_last,ifrmt_sfx_nme as informant_suffix,
IFRMT_RLSHP as inform_relationship,ifrmt_addr_same_as_decd as inform_address_same,ifrmt_addr_strt as inform_address,ifrmt_addr_cty as inform_city,
ifrmt_addr_st as inform_state,fd_fh_nme as funeral_home,fd_fh_loc_cty as funeral_home_city,certfr_frst_nme,certfr_lst_nme,
certfr_addr_strt,certfr_addr_cty,STRIBIMPORTDATE AS IMPORTDATE, covidflag,DECD_DTH_FCLTY_ID,DECD_DTH_DT_MODIFIER,tobacco_contributed,
DECD_PREG_DESC as pregnancy_desc,dt_filed_med as date_filed_medical,dt_filed_legl as date_filed_legal,CMPLT_FL as complete_flag
from deaths_covid
where covidflag='covid' or covidflag='PRESUMED' or covidflag='presumed'
UNION
SELECT TRIM(ST_FILE_NBR) AS STATEID, TRIM(DECD_FRST_NME) AS FIRSTNAME, TRIM(DECD_MIDD_NME) AS MIDDLENAME, TRIM(DECD_LST_NME) AS LASTNAME, 
TRIM(DECD_MAIDN_NME) AS MAIDENNAME, TRIM(DECD_SUFX) AS SUFFIX, DECD_BRTH_DT AS BIRTHDATE, DECD_DTH_DT AS DEATHDATE, 
TRIM(DECD_SEX) AS GENDER, TRIM(RACE) AS RACE, TRIM(HISPANICETHNICITY) AS HISPANICETHNICITY, TRIM(DECD_AGE_TYPE) AS AGE_TYPE, 
DECD_AGE_YR AS AGEYEARS, DECD_AGE_MON AS AGEMONTHS, DECD_AGE_DAY AS AGEDAYS, DECD_AGE_HR AS AGEHOURS, 
DECD_AGE_MIN AS AGEMINUTES, TRIM(DECD_BRTH_CNTRY) AS BIRTHCOUNTRY, TRIM(DECD_BRTH_ST) AS BIRTHSTATE, 
TRIM(DECD_BRTH_CTY) AS BIRTHCITY, TRIM(DECD_RES_NURSING) AS NURSHOME, TRIM(DECD_RES_FCLTY) AS RESFACILITY , 
TRIM(DECD_RES_STRT) AS RESADDRESS, TRIM(DECD_RES_CNTRY) AS RESCOUNTRY, TRIM(DECD_RES_ST) AS RESSTATE, 
TRIM(DECD_RES_CNTY) AS RESCOUNTY, TRIM(DECD_RES_CTY) AS RESCITY, TRIM(DECD_RES_ZIP5) AS ZIP, 
TRIM(DECD_ARMF_FL) AS ARMEDFORCES, TRIM(DECD_EDUC) AS YEARSEDUCATION, TRIM(DECD_OCPTN) AS OCCUPATION, 
TRIM(DECD_IDSTY) AS INDUSTRY, TRIM(DECD_MRTL_STATUS) AS MARITALSTATUS, TRIM(SPS_FRST_NME) AS SPOUSEFIRST, 
TRIM(SPS_MIDD_NME) AS SPOUSEMIDDLE, TRIM(SPS_LST_NME) AS SPOUSELAST, TRIM(FTHR_FRST_NME) AS FATHERFIRST, 
TRIM(FTHR_MIDD_NME) AS FATHERMIDDLE, TRIM(FTHR_LST_NME) AS FATHERLAST, TRIM(FTHR_SFX_NME) AS FATHERSUFFIX, 
TRIM(MTHR_FRST_NME) AS MOTHERFIRST, TRIM(MTHR_MIDD_NME) AS MOTHERMIDDLE, TRIM(MTHR_MAIDN_NME) AS MOTHERMAIDEN, 
TRIM(DECD_PLCE_DTH_TYP) AS PLACETYPE, TRIM(DECD_PLCE_DTH_OTHR) AS PLACEOTHER, TRIM(DECD_DTH_FCLTY) AS FACILITY, 
TRIM(DECD_DTH_FCLTY_OTHR) AS FACILITYOTHER, TRIM(DECD_DTH_STRT) AS DEATHADDRESS, TRIM(DECD_DTH_CNTRY) AS DEATHCOUNTRY, 
TRIM(DECD_DTH_ST) AS DEATHSTATE, TRIM(DECD_DTH_CTY) AS DEATHCITY, TRIM(DECD_DTH_ZIP5) AS DEATHZIP, 
TRIM(DECD_DTH_CNTY) AS DEATHCOUNTY, TRIM(CAUSE_DTH_A) AS CAUSEA, cause_intrvl_a,TRIM(CAUSE_DTH_B) AS CAUSEB,
cause_intrvl_b, TRIM(CAUSE_DTH_C) AS CAUSEC,cause_intrvl_c, TRIM(CAUSE_DTH_D) AS CAUSED,cause_intrvl_d, 
TRIM(CAUSE_DTH_OTHR) AS CAUSEOTHER, me_autpsy,TRIM(CERTFR_MANNER_DTH) AS MANNERDEATH, INJURY_DATE, 
TRIM(INJURY_PLCE_TYP) AS INJURYPLACE, TRIM(INJURY_WORK) AS INJURYWORK, TRIM(INJURY_LOC_STRT) AS INJURYADDRESS, 
TRIM(INJURY_LOC_ST) AS INJURYSTATE, TRIM(INJURY_LOC_CNTY) AS INJURYCOUNTY, TRIM(INJURY_LOC_CNTRY) AS INJURYCOUNTRY , 
TRIM(INJURY_LOC_CTY) AS INJURYCITY, TRIM(INJURY_LOC_ZIP5) AS INJURYZIP, TRIM(INJURY_DESC) AS INJURYDESC, 
ifrmt_frst_nme as informant_first,ifrmt_midd_nme as informant_middle,ifrmt_lst_nme as informant_last,
ifrmt_sfx_nme as informant_suffix,IFRMT_RLSHP as inform_relationship,ifrmt_addr_same_as_decd as inform_address_same,
ifrmt_addr_strt as inform_address,ifrmt_addr_cty as inform_city,ifrmt_addr_st as inform_state,
fd_fh_nme as funeral_home,fd_fh_loc_cty as funeral_home_city,certfr_frst_nme,
certfr_lst_nme,certfr_addr_strt,certfr_addr_cty,STRIBIMPORTDATE AS IMPORTDATE, covidflag,
DECD_DTH_FCLTY_ID,DECD_DTH_DT_MODIFIER,tobacco_contributed,DECD_PREG_DESC as pregnancy_desc,
dt_filed_med as date_filed_medical,dt_filed_legl as date_filed_legal,CMPLT_FL as complete_flag
from deaths_2020
where covidflag='covid' or covidflag='PRESUMED' or covidflag='presumed'
")

covid_table <-  fetch(pulldata, n=-1) %>% clean_names()
```


# review presumed cases
```{r}
covid_table %>% filter(covidflag %in% c('presumed', 'PRESUMED')) %>%
  select(stateid, causea, causeb, causec, caused, causeother) %>% 
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover",  "responsive"), full_width = F, position="left")


```

# Create file for tracker
```{r, message=FALSE, warning=FALSE}

tracker <-  covid_table %>% 
  select(stateid,deathdate,gender,race,hispanicethnicity,ageyears,resstate,rescounty,rescity,zip,deathstate,deathcity,deathzip,deathcounty,importdate,covidflag,complete_flag) %>% 
  mutate(race_ethnicity = case_when(hispanicethnicity=='HISPANIC' ~ 'Hispanic',
                                    TRUE ~ race))



```






# export for reporters
```{r}
#create version date -- get the current date and turn it into a text string
version <-  paste(str_sub(Sys.Date(),1,4), str_sub(Sys.Date(), 6,7), str_sub(Sys.Date(),9,10), sep="")

#create a datafilename with version date tacked on the end
datafilename <-  paste('./data/covid_death_certs', version,  sep='_')

#export the covid_table data file and rename it with the datafilename created above
write.csv(covid_table, paste(datafilename, '.csv', sep=""), row.names=FALSE)




```


```{r}
#disconnect from server
dbDisconnect(con)
```


#export for the tracker

```{r movetoS3, eval=FALSE, echo=FALSE, results="hide"}

#export the file that will be a weekly overwrite,using same name each time
write.csv(tracker, './data/tracker/covid_death_certs_latest.csv', row.names=FALSE)

trackerdatafilename <-  paste('./data/tracker/covid_death_certs', version,  sep='_')

#export the file that will have the version date on it
write.csv(tracker, paste(trackerdatafilename, '.csv', sep=""), row.names=FALSE)



#access the s3 bucket
Sys.setenv("AWS_ACCESS_KEY_ID" =  Sys.getenv("strib_static_key_id"),

           "AWS_SECRET_ACCESS_KEY" =Sys.getenv("strib_static_secret_key"),
           "AWS_DEFAULT_REGION" = "us-west-2")

#get_bucket("static.startribune.com")


#push up the weekly overwrite file
put_object(file = "./data/tracker/covid_death_certs_latest.csv", object = "news/projects/all/2021-covid-scraper/raw/csv/covid_death_certs_latest.csv", bucket = "static.startribune.com")

put_object(file = "./data/tracker/covid_death_certs_latest.csv", object = "news/projects/all/2021-covid-scraper/raw/csv/covid_death_certs_latest.csv", bucket = "static.startribune.com", acl=c("public-read"))


#push up the weekly version file
tracker_path_filename <- paste(trackerdatafilename, '.csv', sep="")
#file <-  paste('\"',tracker_path_filename, '\"', sep="")

file_version <-  paste("covid_death_certs_", version, '.csv', sep="")
path_version_filename <-   paste( "news/projects/all/2021-covid-scraper/raw/csv/", file_version, sep="")

put_object(file = tracker_path_filename, object = path_version_filename, bucket = "static.startribune.com", acl=c("public-read"))

put_object(file = tracker_path_filename, object = path_version_filename, bucket = "static.startribune.com")



```




